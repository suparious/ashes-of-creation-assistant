# Development-specific overrides

services:
  # Frontend in development mode with hot reloading
  frontend:
    build:
      target: dev
    volumes:
      - ../frontend:/app
      - /app/node_modules
    command: npm run dev
    environment:
      - NODE_ENV=development

  # Backend with auto-reload
  backend:
    volumes:
      - ../backend:/app
    environment:
      - DEBUG=true
      - LOG_LEVEL=debug
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Data pipeline in development mode
  data-pipeline:
    volumes:
      - ../data-pipeline:/app
    environment:
      - LOG_LEVEL=debug

  # Milvus with development settings
  milvus-standalone:
    # Override the security_opt to allow running in development environments
    security_opt:
      - seccomp:unconfined
    # We'll keep the ports the same as they're already exposed in the base file
    environment:
      - ETCD_USE_EMBED=true
      - COMMON_SECURITY_ENABLED=false  # Disable security for easier development
    healthcheck:
      # More lenient healthcheck for development
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 120s
    # Use a named volume for development to persist data between restarts
    volumes:
      - milvus-dev-data:/var/lib/milvus

  # Etcd with development settings
  etcd:
    # Fix the advertise URL issue
    command: etcd --advertise-client-urls=http://etcd:2379 --listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    healthcheck:
      # More lenient healthcheck for development
      interval: 60s
      timeout: 30s
      retries: 5
    volumes:
      - etcd-dev-data:/etcd

  # MinIO with development settings
  minio:
    ports:
      - "9001:9001"  # Make MinIO console accessible in development
    volumes:
      - minio-dev-data:/data
    # Keep the command with console address from the base file

  # Redis with development settings
  redis:
    ports:
      - "6379:6379"  # Expose Redis port for direct access
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-ashes_default_pass} --loglevel debug
    volumes:
      - redis-dev-data:/data

  # Development-friendly Nginx configuration
  nginx:
    volumes:
      - ../nginx/conf/myashes.dev.conf:/etc/nginx/conf.d/default.conf
      - ../nginx/www:/var/www/html
    depends_on:
      - frontend
      - backend
    
  # Disable Certbot in development
  certbot:
    profiles: ["disabled"]
    
  # PostgreSQL with development settings
  postgres:
    ports:
      - "5432:5432"  # Expose PostgreSQL port for direct access
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-ashes_dev}
    volumes:
      - postgres-dev-data:/var/lib/postgresql/data

volumes:
  # Development-specific volumes to avoid conflicts with production
  milvus-dev-data:
  etcd-dev-data:
  minio-dev-data:
  redis-dev-data:
  postgres-dev-data:
